#!/bin/bash
echo ""
echo "==============================="
echo " WP-CLI SECURITY AUDIT (SAFE) "
echo "==============================="
echo ""


#############################################
# 1) Перевірка checksum ядра
#############################################
echo "1) Перевірка цілісності core-файлів:"
wp core verify-checksums --format=table
echo ""


#############################################
# 2) Список плагінів (без перевстановлення)
#############################################
echo "2) Плагіни (лише показ):"
wp plugin list --format=table
echo ""


#############################################
# 3) Теми (лише показ)
#############################################
echo "3) Теми сайту:"
wp theme list --format=table
echo ""


#############################################
# 4) Пошук вірусних патернів у PHP-файлах
#############################################
echo "4) Пошук підозрілих патернів у PHP-файлах:"
grep -RIn --include="*.php" -e "base64_decode" -e "eval(" -e "gzinflate" -e "shell_exec" . \
| awk -F: '{printf "| %s | %s | %s |\n", $1, $2, $3}' \
| sed '1i| File | Line | Code |\n|------|------|------|'
echo ""


#############################################
# 5) PHP-файли у wp-content/uploads
#############################################
echo "5) Пошук PHP у wp-content/uploads (не повинно бути!):"
find wp-content/uploads -type f -name "*.php" \
| awk '{print "| " $0 " |"}' \
| sed '1i| Suspicious PHP in uploads |\n|-------------------------------|'
echo ""


#############################################
# 6) Файли, змінені за останні 3 дні
#############################################
echo "6) Нові/змінені файли за останні 3 дні:"
find . -type f -mtime -3 -printf "| %TY-%Tm-%Td %TH:%TM | %p |\n" \
| sed '1i| Modified | File |\n|----------|-------|'
echo ""


#############################################
# 7) Пошук довгих однорядкових файлів (обфускований код)
#############################################
echo "7) Довгі однорядкові PHP-файли (може бути вірус):"
find . -type f -name "*.php" -exec awk 'length($0) > 500 {print FILENAME ": " NR}' {} \; \
| awk -F: '{printf "| %s | %s |\n", $1, $2}' \
| sed '1i| File | Line |\n|------|------|'
echo ""


#############################################
# 8) Пошук підозрілого base64 у БД
#############################################
echo "8) Пошук base64 у wp_options:"
wp db query "SELECT option_id, option_name FROM wp_options WHERE option_value LIKE '%base64%'" --format=table
echo ""


#############################################
# 9) Пошук iframe у контенті
#############################################
echo "9) Пошук iframe у постах:"
wp db query "SELECT ID, post_title FROM wp_posts WHERE post_content LIKE '%iframe%'" --format=table
echo ""


#############################################
# 10) Адміністратори
#############################################
echo "10) Адміністратори сайту:"
wp user list --role=administrator --format=table
echo ""


#############################################
# 11) WP-Cron події
#############################################
echo "11) WP-Cron події:"
wp cron event list --format=table
echo ""


echo "====================================="
echo " ✔ Аудит завершено (нічого не видалено)"
echo "====================================="
